
/*
 * Responsible for creating the Hypereval CodeMirror evaluator widget.
 */
create-event:hypereval.widgets.eval

  /*
   * Used to separate arguments from the rest of our lambda.
   */
  .signal

  /*
   * Figuring out font size to use for widget.
   */
  .defaults
    font-size:9.25
    theme:phosphorus
    line-numbers:bool:true
  p5.auth.my-settings.get

  /*
   * Decorating widget with arguments.
   */
  add:x:/../*/return/*/container
    src:x:/@.signal/--/<-(!/_arg)

  /*
   * Returning widget to caller.
   */
  eval-x:x:/+/**(/.theme|/.line-numbers|/.chrome)|/+/*/container/*/style
  return
    container
      style:"font-size:{0}pt !important;"
        :x:(/@p5.auth.my-settings.get/*/codemirror/*/font-size|/../*/.defaults/*/font-size)/$?value
      oninit

        /*
         * Forward evaluate above.
         */
        .chrome:x:/../*/chrome?value

        /*
         * Including CodeMirror JavaScript.
         */
        p5.web.include-javascript-file
          @MICRO/media/codemirror/lib/codemirror.js
          @MICRO/media/codemirror/addon/dialog/dialog.js
          @MICRO/media/codemirror/addon/search/searchcursor.js
          @MICRO/media/codemirror/addon/search/search.js
          @MICRO/media/codemirror/addon/search/jump-to-line.js
          @MICRO/media/codemirror/addon/edit/closebrackets.js
          @MICRO/media/codemirror/addon/edit/trailingspace.js
          @MICRO/media/codemirror/addon/hint/show-hint.js
          @MICRO/media/codemirror/addon/search/match-highlighter.js
          @MICRO/media/codemirror/addon/selection/mark-selection.js
          @MICRO/media/codemirror/addon/selection/active-line.js
          @MICRO/media/codemirror/addon/display/fullscreen.js
          @MICRO/media/codemirror/mode/hyperlambda/hyperlambda.min.js

        /*
         * Making sure necessary Stylesheet files are included
         */
        .theme:x:(/@p5.auth.my-settings.get/*/codemirror/*/theme|/../*/.defaults/*/theme)/$?value
        p5.web.include-css-file
          @MICRO/media/codemirror/lib/codemirror.css
          @MICRO/media/codemirror/addon/dialog/dialog.css
          @MICRO/media/codemirror/addon/display/fullscreen.css
          @MICRO/media/codemirror/addon/hint/show-hint.css
        p5.web.include-css-file:@MICRO/media/codemirror/theme/{0}.css
          :x:/@.theme?value

        /*
         * Including AutoCompletion JSON.
         */
        micro.widgets.codemirror._include-auto-complete

        /*
         * If this is a "chrome plugin load", we don't apply extra keyboard shortcuts.
         */
        .extra-keys:@",
    'Alt-S':function(cm) {{p5.$('hypereval-save-snippet').raise('onclick');}},
    'Alt-L':function(cm) {{p5.$('hypereval-load-snippet').raise('onclick');}},
    'Alt-D':function(cm) {{p5.$('hypereval-delete-snippet').raise('onclick');}},
    'Alt-N':function(cm) {{p5.$('hypereval-new-snippet').raise('onclick');}},
    'Alt-P':function(cm) {{p5.$('hypereval-preview-snippet').raise('onclick');}}
"

        /*
         * Transforming input textarea to CodeMirror instance.
         */
        .line-numbers:x:(/@p5.auth.my-settings.get/*/codemirror/*/line-numbers|/../*/.defaults/*/line-numbers)/$?value
        set:x:/-?value
          to-lower:x:/./-?value.string
        p5.io.unroll-path:@HYPEREVAL/
        p5.web.send-javascript:@"p5.hypereval_input = CodeMirror.fromTextArea(p5.$('hypereval-input').el, {{
  mode:'hyperlambda',
  theme:'{1}',
  lineNumbers:{2},
  styleActiveLine:true,
  path:'{0}/media/codemirror/',
  autofocus:true,
  tabSize:2,
  indentAuto:true,
  autoCloseBrackets:true,
  showTrailingSpace:true,
  extraKeys: {{
    'Ctrl-Space':'autocomplete',
    'Shift-Tab':'indentLess',
    'Tab':'indentMore',
    'Alt-F': 'findPersistent',
    'Alt-M':function(cm) {{cm.setOption('fullScreen', !cm.getOption('fullScreen'));}},
    'Alt-E':function(cm) {{
      p5.$('hypereval-evaluate-snippet').raise('onclick', {{
        onsuccess:function(ret, evt) {{
          if (ret.code) {{
            p5.hypereval_output.getDoc().setValue(ret.code);
          }}
        }}
      }});
    }},
    'Alt-V':function(cm) {{p5.$('hypereval-view-output').raise('onclick');}}{3}
  }}
}});
p5.hypereval_input.on('change',function (cMirror) {{
  p5.$('hypereval-input').el.value = cMirror.getValue();
}});
p5.hypereval_input.setSize('100%', '400px');"
          :x:/@p5.io.unroll-path?value
          :x:/@.theme?value
          :x:/@.line-numbers?value
          :x:/@.extra-keys?value

      widgets
        literal:hypereval-input
          element:textarea
          placeholder:Hyperlambda ...
          class:fill
          rows:20
          oninit

            /*
             * Checking if we have some code in our session.
             */
            p5.web.session.get:hypereval.snippet-name
            if:x:/@p5.web.session.get/*?value
              hypereval.widgets.eval.load-snippet:x:/@p5.web.session.get/*?value

        div
          class:right air-top
          widgets:bottom-toolbars
          widgets

            /*
             * Extra toolbar buttons, for loading snippets, saving snippets, etc.
             */
            micro.widgets.folder-plugin
              folder:@HYPEREVAL/helpers/bottom-extra-toolbar-buttons/
              class:strip
              style:"margin-right:1rem;"

            /*
             * Main toolbars, for evaluating Hyperlambda, etc.
             */
            micro.widgets.folder-plugin
              folder:@HYPEREVAL/helpers/bottom-toolbar-buttons/
              class:strip


        div:hypereval-output-wrapper
          visible:false
          style:"clear:both;"
          widgets
            literal:hypereval-output
              element:textarea
              class:fill
              rows:10
              oninit

                /*
                 * Default values.
                 */
                .defaults
                  font-size:9.25
                  theme:phosphorus
                  line-numbers:bool:true

                /*
                 * Retrieving settings for widget.
                 */
                p5.auth.my-settings.get
                .line-numbers:x:(/@p5.auth.my-settings.get/*/codemirror/*/line-numbers|/@.defaults/*/line-numbers)/$?value
                set:x:/-?value
                  to-lower:x:/./-?value.string

                /*
                 * Transforming output textarea to CodeMirror instance.
                 */
                p5.io.unroll-path:@MICRO/
                p5.web.send-javascript:@"p5.hypereval_output = CodeMirror.fromTextArea(p5.$('hypereval-output').el, {{
  mode:'hyperlambda',
  theme:'{0}',
  lineNumbers:{1},
  styleActiveLine:true,
  path:'{2}/media/codemirror/',
  tabSize:2,
  indentAuto:true,
  readOnly:true
}});"
                  :x:(/@p5.auth.my-settings.get/*/codemirror/*/theme|/../*/.defaults/*/theme)/$?value
                  :x:/@.line-numbers?value
                  :x:/@p5.io.unroll-path?value
