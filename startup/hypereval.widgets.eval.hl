
/*
 * Responsible for creating the CodeMirror Hyperlambda evaluator widget.
 */
create-event:hypereval.widgets.eval

  /*
   * Returning widget to caller.
   */
  return
    container
      oninit

        /*
         * Including CodeMirror JavaScript.
         */
        p5.web.include-javascript-file
          @HYPEREVAL/media/codemirror/lib/codemirror.js
          @HYPEREVAL/media/codemirror/addon/selection/active-line.js
          @HYPEREVAL/media/codemirror/addon/display/fullscreen.js
          @HYPEREVAL/media/codemirror/addon/hint/show-hint.js
          @HYPEREVAL/media/codemirror/mode/hyperlambda/hyperlambda.js

        /*
         * Making sure necessary Stylesheet files are included
         */
        p5.web.include-css-file
          @HYPEREVAL/media/codemirror/lib/codemirror.css
          @HYPEREVAL/media/codemirror/theme/duotone-light.css
          @HYPEREVAL/media/codemirror/addon/hint/show-hint.css
          @HYPEREVAL/media/codemirror/addon/display/fullscreen.css

        /*
         * Including keywords JSON on page.
         */
        vocabulary
        join:x:/@vocabulary/*?value
          sep:,
          wrap:'
        p5.web.include-javascript:@"CodeMirror._hyperlispKeywords = [{0}];"
          :x:/@join?value

        /*
         * Transforming input textarea to CodeMirror instance.
         */
        p5.io.unroll-path:@HYPEREVAL/
        p5.web.send-javascript:@"p5.hypereval_input = CodeMirror.fromTextArea(p5.$('hypereval-input').el, {{
  mode:'hyperlambda',
  theme:'duotone-light',
  lineNumbers:true,
  styleActiveLine:true,
  path:'{0}/media/codemirror/',
  autofocus:true,
  tabSize:2,
  indentAuto:true,
  extraKeys: {{
    'Ctrl-Space':'autocomplete',
    'Shift-Tab':'indentLess',
    'Tab':'indentMore',
    'Alt-F':function(cm) {{cm.setOption('fullScreen', !cm.getOption('fullScreen'));}},
    'Alt-E':function(cm) {{
      p5.$('hypereval-evaluate-button').raise('.onclick', {{
        onsuccess:function(ret, evt) {{
          if (ret.code) {{
            p5.hypereval_output.getDoc().setValue(ret.code);
          }}
        }}
      }});
    }}
  }}
}});
p5.hypereval_input.on('change',function (cMirror) {{
  p5.$('hypereval-input').el.value = cMirror.getValue();
}});
p5.hypereval_input.setSize('100%', '500px');"
          :x:/@p5.io.unroll-path?value

      widgets
        literal:hypereval-input
          element:textarea
          class:fill
          rows:20
          oninit

            /*
             * Setting focus initially to "input textarea".
             */
            micro.page.set-focus:x:/../*/_event?value

            /*
             * Checking if we have some code in our session.
             */
            p5.web.session.get:hypereval.code
            if:x:/@p5.web.session.get/*?value
              set-widget-property:hypereval-input
                innerValue:x:/@p5.web.session.get/*?value

        div
          class:right
          widgets
            div
              class:strip
              style:"display:inline-block;"
              widgets
                button:hypereval-evaluate-button
                  innerValue:Evaluate
                  onclick:@"p5.$('hypereval-evaluate-button').raise('.onclick',{onsuccess:function(ret, evt){if (ret.code){p5.hypereval_output.getDoc().setValue(ret.code);}}});return false;"
                  .onclick

                    /*
                     * Retrieving Hyperlambda and evaluating it.
                     */
                    .exe:node:"exe"
                    get-widget-property:hypereval-input
                      innerValue
                    hyper2lambda:x:/@get-widget-property/*/*?value
                    set:x:/@.exe/#/*
                    add:x:/@.exe/#
                      src:x:/@hyper2lambda/*
                    eval-mutable:x:/@.exe/#

                    /*
                     * Then converting lambda result to Hyperlambda, and returning back to client as JSON
                     */
                    lambda2hyper:x:/@.exe/#/*
                    get-widget-property:hypereval-output-wrapper
                      visible
                    if:x:/@get-widget-property/*/*?value
                      p5.web.return-response-object:code
                        src:x:/@lambda2hyper?value

                    /*
                     * Storing code in session, to make it more easily available.
                     */
                    p5.web.session.set:hypereval.code
                      src:x:/../*/get-widget-property/[0,1]/*/*?value

                button
                  innerValue:Output
                  onclick

                    /*
                     * Toggles visibility of output.
                     */
                    get-widget-property:hypereval-output-wrapper
                      visible
                    if:x:/@get-widget-property/*/*?value
                      set-widget-property:hypereval-output-wrapper
                        visible:false
                    else
                      set-widget-property:hypereval-output-wrapper
                        visible:true

        div:hypereval-output-wrapper
          visible:false
          style:"clear:both;"
          widgets
            literal:hypereval-output
              element:textarea
              class:fill
              rows:10
              oninit

                /*
                 * Transforming output textarea to CodeMirror instance.
                 */
                p5.io.unroll-path:@HYPEREVAL/
                p5.web.send-javascript:@"p5.hypereval_output = CodeMirror.fromTextArea(p5.$('hypereval-output').el, {{
mode:'hyperlambda',
theme:'duotone-light',
lineNumbers:true,
styleActiveLine:true,
path:'{0}/media/codemirror/',
tabSize:2,
indentAuto:true,
readOnly:true
}});"
                  :x:/@p5.io.unroll-path?value
